# 代理签名场景下505错误排查指南

## 📋 场景确认

✅ **已确认：**
- 方案二：代理签名
- 证书：法人的（RUT: 24529296-1）
- CAF：公司的（RUT: 78065438-4）
- 代理关系：已在SII系统中授权

❌ **仍然报错：** 505 "Firma DTE Incorrecta (Rechaza DTE)"

---

## 🔍 可能的原因（按优先级排序）

### 原因1：Firmante授权角色未正确配置（最可能）

**SII要求：**
- 证书对应的自然人必须在SII系统中注册为 **"Firmante autorizado"**（授权签名人）
- "Administrador"角色的人必须在SII后台登记这个Firmante的RUT
- 即使代理关系已配置，如果没有"Firmante"角色，仍然会被拒绝

**检查步骤：**

1. **登录SII系统（使用公司RUT账户）**
   - RUT: `78065438-4`

2. **检查Firmante列表**
   - 进入"Firmantes autorizados"或"授权签名人"页面
   - 查看是否已注册 `24529296-1` 为Firmante
   - 确认状态为"激活"或"Activo"

3. **检查证书注册**
   - 确保证书（SerialNumber: 24529296-1）已在SII系统中注册
   - 确保证书状态为"有效"或"Vigente"

**如果未配置：**
- 需要Administrador角色的人添加该Firmante
- 重新注册证书（如果需要）

---

### 原因2：签名结构细节问题

#### 2.1 Documento Signature的位置

**要求：**
- Documento的Signature应该在`<DTE>`内、`<Documento>`外
- SetDTE的Signature应该在`<EnvioBOLETA>`内、`<SetDTE>`外

**当前结构（检查生成的XML）：**

```xml
<EnvioBOLETA>
  <SetDTE ID="BOLETA_ENVIO_78065438-4_20260117">
    <DTE version="1.0">
      <Documento ID="BoletaElectronica_1832">...</Documento>
      <Signature xmlns="http://www.w3.org/2000/09/xmldsig#">
        <!-- Documento的Signature -->
      </Signature>
    </DTE>
  </SetDTE>
  <Signature xmlns="http://www.w3.org/2000/09/xmldsig#">
    <!-- SetDTE的Signature -->
  </Signature>
</EnvioBOLETA>
```

✅ **当前结构正确**

---

#### 2.2 ENVELOPED Transform的处理

**当签名SetDTE时：**
- SetDTE内部已经包含了Documento的Signature
- ENVELOPED transform应该**排除SetDTE自己的Signature**，但**包含Documento的Signature**

**当前实现：**
```java
// 签名SetDTE时，Documento的Signature已经在SetDTE内部
// ENVELOPED transform会自动排除SetDTE自己的Signature
List<Transform> transforms = Collections.singletonList(
    fac.newTransform(Transform.ENVELOPED, (TransformParameterSpec) null)
);
```

✅ **实现正确**

---

#### 2.3 ID属性的设置

**要求：**
- ID属性必须被正确标记为XmlID
- 用于Reference URI引用

**当前实现：**
```java
target.setIdAttribute("ID", true);
```

✅ **实现正确**

---

### 原因3：签名后DOM被修改

**问题：**
- 签名后调用`cleanBase64Text()`可能修改了已签名元素之外的内容
- 虽然应该不影响，但某些严格验证器可能会有问题

**当前代码顺序：**
```java
signXmlForSii(doc, "Documento", ...);      // 1. 签名Documento
signXmlForSiiOut(doc, "SetDTE", ...);       // 2. 签名SetDTE
cleanBase64Text(doc);                       // 3. 清理Base64
```

**潜在问题：**
- `cleanBase64Text()`在SetDTE签名后调用
- 如果它修改了SetDTE的内容（即使不是签名的内容），可能影响验证

**建议：**
- 确保`cleanBase64Text()`只清理SignatureValue和KeyInfo中的Base64，不修改被签名的元素内容
- 这个应该已经正确实现了

---

### 原因4：证书有效期或状态问题

**检查项：**
- [ ] 证书是否在有效期内（notBefore <= now <= notAfter）
- [ ] 证书是否未被吊销
- [ ] 证书的CA是否被SII信任
- [ ] 证书在SII系统中的状态是否为"有效"

**验证方法：**
```java
Date now = new Date();
if (cert.getNotBefore().after(now)) {
    throw new IllegalArgumentException("证书尚未生效");
}
if (cert.getNotAfter().before(now)) {
    throw new IllegalArgumentException("证书已过期");
}
```

---

### 原因5：Caratula中的RUT信息不匹配

**要求：**
- Caratula中的RUTEmisor必须与Documento中的rutEmisor一致
- Caratula中的RUTEnvia必须与证书RUT一致（代理签名场景）

**检查生成的XML：**
- 确认Caratula中的RUTEmisor = `78065438-4`
- 确认Caratula中的RUTEnvia = `24529296-1`

---

## 🛠️ 建议的排查步骤

### 步骤1：验证Firmante授权（最重要）

1. **登录SII系统**
   ```
   URL: https://www.sii.cl
   账户: 78065438-4（公司RUT）
   ```

2. **检查Firmante授权**
   - 导航到"Firmantes autorizados"或"授权签名人"
   - 搜索RUT: `24529296-1`
   - 确认已注册且状态为"激活"

3. **检查证书注册**
   - 导航到"Certificados digitales"或"数字证书"
   - 搜索SerialNumber或RUT: `24529296-1`
   - 确保证书已注册且状态为"有效"

---

### 步骤2：对比SII示例XML

1. **下载SII官方示例XML**
   - 从SII文档或测试环境下载一个成功签名的XML

2. **对比签名结构**
   - Signature位置
   - Transform算法
   - ID属性格式
   - 证书Subject格式

---

### 步骤3：使用SII验证工具

如果SII提供"检查firma digital"工具：
1. 上传生成的XML
2. 仅验证签名合法性
3. 查看详细错误信息

---

### 步骤4：添加详细日志

在签名过程中添加日志，输出：
- 证书Subject
- 证书SerialNumber（RUT）
- 被签名元素的ID
- DigestValue（用于验证）
- 签名是否成功

**示例代码：**
```java
X509Certificate cert = (X509Certificate) ks.getCertificate(alias);
String subject = cert.getSubjectDN().getName();
System.out.println("=== 签名信息 ===");
System.out.println("证书Subject: " + subject);
System.out.println("证书有效期: " + cert.getNotBefore() + " ~ " + cert.getNotAfter());

Element target = (Element) doc.getElementsByTagName(tagName).item(0);
String idValue = target.getAttribute("ID");
System.out.println("签名元素ID: " + idValue);
System.out.println("Reference URI: #" + idValue);
```

---

## 📋 完整检查清单

### SII系统配置
- [ ] Firmante（24529296-1）已在SII系统中注册为"Firmante autorizado"
- [ ] 代理签名关系已激活
- [ ] 证书已在SII系统中注册
- [ ] 证书状态为"有效"

### 证书有效性
- [ ] 证书在有效期内
- [ ] 证书未被吊销
- [ ] 证书的CA被SII信任（如Acerta.com）

### XML签名结构
- [ ] Documento的Signature在DTE内、Documento外 ✅
- [ ] SetDTE的Signature在EnvioBOLETA内、SetDTE外 ✅
- [ ] Transform使用enveloped-signature ✅
- [ ] SignatureValue无换行符 ✅
- [ ] ID属性正确设置 ✅

### RUT匹配
- [ ] 证书RUT（24529296-1）与rutEnvia匹配 ✅
- [ ] Caratula中的RUTEmisor与Documento中的rutEmisor匹配
- [ ] Caratula中的RUTEnvia与证书RUT匹配

---

## 🎯 立即行动

**优先级1：验证Firmante授权**

这是最可能的原因。请立即检查：
1. 登录SII系统（公司账户）
2. 查看Firmante列表
3. 确认`24529296-1`已注册为"Firmante autorizado"

如果未注册，需要：
- 使用Administrador角色添加该Firmante
- 重新测试

---

**优先级2：检查证书注册**

1. 在SII系统中查看证书列表
2. 确认证书（SerialNumber: 24529296-1）已注册
3. 确保证书状态为"有效"

---

**优先级3：对比示例XML**

如果SII提供示例XML，下载并对比：
- Signature结构
- 证书Subject格式
- ID属性格式

---

## 💡 总结

既然代理关系已配置，最可能的原因是：

1. **Firmante授权角色未正确配置**（60%概率）
   - 证书对应的自然人未在SII系统中注册为"Firmante autorizado"
   - 这是最常见但容易被忽视的问题

2. **证书注册或状态问题**（30%概率）
   - 证书未在SII系统中注册
   - 证书状态不是"有效"

3. **XML签名结构细节问题**（10%概率）
   - 某些细微的结构差异导致验证失败

**建议先检查Firmante授权，这是最可能的原因！**
