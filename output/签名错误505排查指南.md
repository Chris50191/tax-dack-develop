# SII错误505 "Firma DTE Incorrecta" 排查指南

## 错误信息
```json
{
  "codigo": 505,
  "descripcion": "Firma DTE Incorrecta (Rechaza DTE)"
}
```

这个错误表示SII验证DTE签名时失败。

---

## 🔍 关键问题点排查

### 问题1：Transform算法必须使用ENVELOPED

**您提供的XML中（第118行）：**
```xml
<Transform Algorithm="http://www.w3.org/TR/2001/REC-xml-c14n-20010315" />
```

**❌ 错误：这是C14N规范化算法，不是Transform！**

**✅ 正确应该是：**
```xml
<Transform Algorithm="http://www.w3.org/2000/09/xmldsig#enveloped-signature" />
```

**⚠️ 注意：** 您提供的XML文件可能不是用当前代码生成的，因为：
- 该XML使用RUT `76416414-8`，而您的代码示例使用 `78065438-4`
- Transform算法不正确

---

## ✅ 代码检查：当前实现是否正确

### 检查点1：Transform设置

**代码位置：** `InvoiceGenerator.java` 第372-373行

```java
List<Transform> transforms = Collections.singletonList(
    fac.newTransform(Transform.ENVELOPED, (TransformParameterSpec) null)
);
```

✅ **正确**：使用ENVELOPED transform

---

### 检查点2：签名顺序

**正确的签名顺序应该是：**
1. 插入TED ✅
2. 签名Documento ✅  
3. 签名SetDTE ✅
4. 清理Base64内容 ✅

**代码位置：** `InvoiceGenerator.java` 第109-128行
```java
TedGenerator.insertTed(doc, cafFile);  // 1. 插入TED
signXmlForSii(doc, "Documento", ...);  // 2. 签名Documento
signXmlForSiiOut(doc, "SetDTE", ...);  // 3. 签名SetDTE
cleanBase64Text(doc);                  // 4. 清理Base64
```

✅ **顺序正确**

---

### 检查点3：签名后移动Signature节点

**代码位置：** `InvoiceGenerator.java` 第407-413行

```java
// 8. 移动 Signature 到元素外部 (SII 要求)
NodeList sigList = doc.getElementsByTagNameNS(XMLSignature.XMLNS, "Signature");
if (sigList.getLength() > 0) {
    Node signatureNode = sigList.item(sigList.getLength() - 1);
    Node parentNode = target.getParentNode();
    parentNode.appendChild(signatureNode);
}
```

⚠️ **潜在问题**：签名后移动Signature节点**不应该**影响签名验证，因为签名是基于元素ID的引用。

但需要确保：
- Reference URI正确指向元素ID
- 元素ID在移动后仍然有效

---

## 🔧 可能的问题和修复建议

### 问题A：签名时引用的元素不正确

**检查：**
- Documento的ID是否正确设置
- SetDTE的ID是否正确设置
- Reference URI是否匹配元素ID

**验证方法：**
在XML中搜索：
```xml
<Documento ID="...">  <!-- 检查这个ID -->
<Reference URI="#...">  <!-- 检查是否匹配 -->
```

---

### 问题B：签名后DOM被修改

**可能原因：**
- 签名后调用`cleanBase64Text()`修改了DOM
- 移动Signature节点时出现问题
- Transformer序列化时改变了内容

**修复建议：**
确保签名完成后不再修改被签名的元素内容。

---

### 问题C：证书问题

**检查：**
1. 证书是否过期
2. 证书是否被SII信任
3. 证书的RUT是否与发票中的rutEmisor匹配
4. 证书是否来自受信任的CA

---

### 问题D：DigestValue计算不正确

**可能原因：**
- 规范化方法不正确
- Transform应用不正确
- 元素ID属性未被正确标记为XmlID

**检查：**
确保：
```java
target.setIdAttribute("ID", true);  // 在签名前必须设置
```

---

## 🛠️ 建议的修复步骤

### 步骤1：验证生成的XML

使用您修复后的代码重新生成XML，检查：
1. Transform是否使用ENVELOPED
2. SignatureValue是否没有换行符
3. 元素ID是否正确

---

### 步骤2：检查签名验证

使用XML签名验证工具（如xmlsec1）验证本地签名：

```bash
xmlsec1 --verify --pubkey-cert-pem certificate.pem invoice.xml
```

---

### 步骤3：对比SII示例XML

下载SII官方示例XML，对比：
- Signature结构
- Transform算法
- 签名位置
- 元素ID格式

---

### 步骤4：添加调试日志

在签名前后添加日志，输出：
- 被签名元素的ID
- Reference URI
- DigestValue
- 签名是否成功

---

## 📋 检查清单

- [ ] Transform使用 `http://www.w3.org/2000/09/xmldsig#enveloped-signature`
- [ ] CanonicalizationMethod使用 `http://www.w3.org/TR/2001/REC-xml-c14n-20010315`
- [ ] SignatureMethod使用 `http://www.w3.org/2000/09/xmldsig#rsa-sha1`
- [ ] DigestMethod使用 `http://www.w3.org/2000/09/xmldsig#sha1`
- [ ] Reference URI正确指向元素ID（如 `#BoletaElectronica_1832`）
- [ ] 元素ID属性被正确标记为XmlID
- [ ] SignatureValue没有换行符或&#13;实体
- [ ] KeyInfo包含KeyValue和X509Data
- [ ] 证书有效且未被过期
- [ ] 证书RUT与发票rutEmisor匹配
- [ ] 签名顺序：先TED，再Documento，最后SetDTE

---

## 💡 立即可以尝试的修复

### 修复1：确保ID属性正确设置

在签名前，确保：
```java
Element target = (Element) doc.getElementsByTagName(tagName).item(0);
target.setIdAttribute("ID", true);  // 必须在签名前设置
```

✅ 代码中已有此设置（第369行）

---

### 修复2：验证签名后元素未被修改

确保在签名完成后，不再修改被签名元素的内容。

✅ 代码中签名后只移动Signature节点，不修改元素内容

---

### 修复3：检查最终XML输出

使用修复后的代码重新生成XML，并验证：
1. Transform算法正确
2. SignatureValue连续（无换行符）
3. 所有Base64内容已清理

---

## 🎯 下一步行动

1. **重新生成XML**：使用修复后的代码生成新的XML文件
2. **验证Transform**：检查新XML中Transform是否使用ENVELOPED
3. **本地验证**：使用xmlsec工具验证签名
4. **发送测试**：发送到SII测试环境验证

---

*如果重新生成的XML仍然失败，请提供新的XML文件，特别是Signature部分，我可以进一步分析。*
