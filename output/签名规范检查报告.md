# SII Boleta XML数字签名规范检查报告

**检查日期：** 2026-01-17  
**检查文件：** `invoice_50_20260117_084348_04_外部签名SetDTE后_最终XML.xml`

---

## 📋 检查结果概览

| 检查项 | 状态 | 说明 |
|--------|------|------|
| **签名结构完整性** | ✅ 通过 | 两个签名都存在且结构完整 |
| **签名位置** | ✅ 通过 | 符合SII要求（外部签名） |
| **签名算法** | ✅ 通过 | RSA_SHA1 |
| **规范化方法** | ✅ 通过 | Inclusive C14N |
| **Transform** | ✅ 通过 | ENVELOPED |
| **KeyInfo完整性** | ✅ 通过 | 包含KeyValue和X509Data |
| **Reference URI** | ✅ 通过 | 正确引用目标元素ID |
| **TED签名** | ✅ 通过 | FRMT存在且算法正确 |
| **Base64格式** | ⚠️ 警告 | SignatureValue中包含&#13;换行符 |

---

## ✅ 符合规范的检查项

### 1. 内部签名（Documento节点签名）- 第136-164行

**签名位置：** 在`<DTE>`内，`<Documento>`外 ✅
```xml
<DTE version="1.0">
  <Documento ID="BoletaElectronica_1832">...</Documento>
  <Signature xmlns="http://www.w3.org/2000/09/xmldsig#">
    ...
  </Signature>
</DTE>
```

**SignedInfo结构：** ✅ 完整
- **CanonicalizationMethod:** `http://www.w3.org/TR/2001/REC-xml-c14n-20010315` ✅ (Inclusive C14N)
- **SignatureMethod:** `http://www.w3.org/2000/09/xmldsig#rsa-sha1` ✅
- **Reference URI:** `#BoletaElectronica_1832` ✅ (正确引用Documento的ID)
- **Transform:** `http://www.w3.org/2000/09/xmldsig#enveloped-signature` ✅
- **DigestMethod:** `http://www.w3.org/2000/09/xmldsig#sha1` ✅

**KeyInfo：** ✅ 完整
- 包含`<KeyValue>`（RSA公钥信息）✅
- 包含`<X509Data>`（X509证书）✅

---

### 2. 外部签名（SetDTE节点签名）- 第169-197行

**签名位置：** 在`<EnvioBOLETA>`内，`<SetDTE>`外 ✅
```xml
<EnvioBOLETA>
  <SetDTE ID="BOLETA_ENVIO_78065438-4_20260117">...</SetDTE>
  <Signature xmlns="http://www.w3.org/2000/09/xmldsig#">
    ...
  </Signature>
</EnvioBOLETA>
```

**SignedInfo结构：** ✅ 完整
- **CanonicalizationMethod:** `http://www.w3.org/TR/2001/REC-xml-c14n-20010315` ✅
- **SignatureMethod:** `http://www.w3.org/2000/09/xmldsig#rsa-sha1` ✅
- **Reference URI:** `#BOLETA_ENVIO_78065438-4_20260117` ✅ (正确引用SetDTE的ID)
- **Transform:** `http://www.w3.org/2000/09/xmldsig#enveloped-signature` ✅
- **DigestMethod:** `http://www.w3.org/2000/09/xmldsig#sha1` ✅

**KeyInfo：** ✅ 完整（与内部签名相同）

---

### 3. TED签名（电子印章）- 第130行

**FRMT标签：** ✅ 存在
```xml
<FRMT algoritmo="SHA1withRSA">sH4F2HXILgb7yK8TsnH7vJCB8JCvNcndkMjcOdg4dj5eHFHWZ4lCrw3NMQDSkvL4X1W7i6Fwdfct6/BiNhGvkw==</FRMT>
```

- **算法：** `SHA1withRSA` ✅
- **签名值：** Base64编码的签名值 ✅

---

## ⚠️ 需要关注的问题

### 问题1：SignatureValue中包含&#13;换行符

**位置：**
- 内部签名的SignatureValue（第148-152行）
- 外部签名的SignatureValue（第181-185行）

**当前格式：**
```xml
<SignatureValue>LCnQ0nEnXZaC+9wbWaPqBphwhl9BC4r60YMY/Yx1fXl4Hhze86qHd5+9dwKY6qmXRTE1svnvjNiF&#13;
ewW6htYNjwBFov9fcjgRFuFUu9H4WwlC347O46H9H4tz5AVaA+42N2RBEBzY0UrJvSC5ypQCcqyQ&#13;
...</SignatureValue>
```

**问题说明：**
- `&#13;` 是XML实体编码的回车符（\r）
- 虽然XML解析器会将其视为换行，但这可能不是最佳实践
- SII系统**通常要求**Base64签名值是连续的，没有换行符

**影响评估：**
- ⚠️ **低风险**：大多数XML解析器会正确处理，但有些严格的验证器可能不接受
- ⚠️ **可能影响**：如果SII系统对Base64格式有严格要求，可能导致验证失败

**建议：**
虽然代码中有`cleanBase64Text()`方法来清理Base64内容，但它只清理了`Modulus`和`X509Certificate`标签，没有清理`SignatureValue`。

---

### 问题2：代码中cleanBase64Text()方法不完整

**当前代码（第461-472行）：**
```java
private static void cleanBase64Text(Document doc) {
    String[] tags = {"Modulus", "X509Certificate"};
    // 只清理了Modulus和X509Certificate
    // 没有清理SignatureValue
}
```

**建议修复：**
应该也清理`SignatureValue`标签中的换行符。

---

## 📊 SII规范符合性对比表

| SII要求 | 当前实现 | 符合性 |
|---------|----------|--------|
| **签名算法：RSA_SHA1** | ✅ RSA_SHA1 | ✅ 100% |
| **规范化：Inclusive C14N** | ✅ Inclusive C14N | ✅ 100% |
| **Transform：ENVELOPED** | ✅ ENVELOPED | ✅ 100% |
| **KeyInfo包含KeyValue** | ✅ 包含 | ✅ 100% |
| **KeyInfo包含X509Data** | ✅ 包含 | ✅ 100% |
| **签名位置：外部签名** | ✅ 在目标元素外部 | ✅ 100% |
| **Reference URI：正确引用ID** | ✅ 正确 | ✅ 100% |
| **Base64签名值：无换行符** | ⚠️ 包含&#13; | ⚠️ 95% |

---

## ✅ 总结

### 符合规范的部分：
1. ✅ **签名结构完整**：两个签名（Documento和SetDTE）都存在且结构正确
2. ✅ **签名算法正确**：使用RSA_SHA1算法
3. ✅ **规范化方法正确**：使用Inclusive C14N
4. ✅ **Transform正确**：使用ENVELOPED transform
5. ✅ **KeyInfo完整**：包含KeyValue和X509Data
6. ✅ **签名位置正确**：签名位于目标元素外部
7. ✅ **Reference URI正确**：正确引用了目标元素的ID
8. ✅ **TED签名正确**：FRMT标签存在且算法为SHA1withRSA

### 需要注意的问题：
1. ⚠️ **SignatureValue中的&#13;换行符**：虽然不是致命问题，但建议清理以提高兼容性

---

## 🔧 修复建议

### 建议1：扩展cleanBase64Text()方法

修改`InvoiceGenerator.java`中的`cleanBase64Text()`方法，添加清理`SignatureValue`：

```java
private static void cleanBase64Text(Document doc) {
    String[] tags = {"Modulus", "X509Certificate", "SignatureValue"};  // 添加SignatureValue
    for (String tag : tags) {
        NodeList nl = doc.getElementsByTagNameNS("*", tag);
        for (int i = 0; i < nl.getLength(); i++) {
            Node n = nl.item(i);
            if (n != null && n.getTextContent() != null) {
                // 清理所有空白字符，包括&#13;
                String cleaned = n.getTextContent().replaceAll("\\s+", "");
                n.setTextContent(cleaned);
            }
        }
    }
}
```

### 建议2：在签名后立即清理

确保在每次签名后都调用`cleanBase64Text()`，并且方法能够处理所有Base64内容。

---

## 📝 结论

**总体评估：✅ 签名基本符合SII规范**

您的XML签名**整体上符合SII规范**，签名结构、算法、位置都正确。唯一需要改进的是`SignatureValue`中的换行符处理，这是一个小问题，可以通过修改`cleanBase64Text()`方法来解决。

**建议：**
1. 修改`cleanBase64Text()`方法，添加对`SignatureValue`的清理
2. 重新生成XML文件并验证`SignatureValue`中不再包含&#13;
3. 可以先用当前文件测试SII系统是否能接受，如果被拒绝再修复

---

*检查完成时间：2026-01-17*
